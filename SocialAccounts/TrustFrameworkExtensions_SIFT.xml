<?xml version="1.0" encoding="utf-8" ?>
<TrustFrameworkPolicy 
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
  xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
  xmlns="http://schemas.microsoft.com/online/cpim/schemas/2013/06" 
  PolicySchemaVersion="0.3.0.0" 
  TenantId="archb2cpoc.onmicrosoft.com" 
  PolicyId="B2C_1A_TrustFrameworkExtensions_sift" 
  PublicPolicyUri="http://archb2cpoc.onmicrosoft.com/B2C_1A_TrustFrameworkExtensions_sift">
  
  <BasePolicy>
    <TenantId>archb2cpoc.onmicrosoft.com</TenantId>
    <PolicyId>B2C_1A_TrustFrameworkBase_sift</PolicyId>
  </BasePolicy>
  <BuildingBlocks>

	<ClaimsSchema>
	
		<ClaimType Id="objectGuid">
			<DisplayName>User's Object GUID</DisplayName>
			<DataType>string</DataType>
			<DefaultPartnerClaimTypes>
				<Protocol Name="OpenIdConnect" PartnerClaimType="objectGuid" />
				<Protocol Name="SAML2" PartnerClaimType="http://schemas.xmlsoap.org/ws/2005/05/identity/claims/ObjectGUID" />
			</DefaultPartnerClaimTypes>
			<UserHelpText>Object globally unique identifier (ID) of the user object in its source directory.</UserHelpText>
		</ClaimType>
	  
		<ClaimType Id="EventType">
			<DisplayName>Event type</DisplayName>
			<DataType>string</DataType>
		</ClaimType>
		
		<ClaimType Id="EventTimestamp">
		  <DisplayName>Event timestamp</DisplayName>
		  <DataType>string</DataType>
		</ClaimType>
		
		<ClaimType Id="PolicyId">
		  <DisplayName>Policy Id</DisplayName>
		  <DataType>string</DataType>
		</ClaimType>
		
		<ClaimType Id="CorrelationId">
		  <DisplayName>Correlation Id</DisplayName>
		  <DataType>string</DataType>
		</ClaimType>
		
		<ClaimType Id="federatedUser">
		  <DisplayName>Federated user</DisplayName>
		  <DataType>boolean</DataType>
		</ClaimType>
		
		<ClaimType Id="parsedDomain">
		  <DisplayName>Domain name</DisplayName>
		  <DataType>string</DataType>
		  <UserHelpText>The domain portion of the email address.</UserHelpText>
		</ClaimType>
		
	</ClaimsSchema>
	
	<ClaimsTransformations>

		<ClaimsTransformation Id="CreateObjectId" TransformationMethod="CreateAlternativeSecurityId">
			<InputClaims>
				<InputClaim ClaimTypeReferenceId="issuerUserId" TransformationClaimType="key" />
				<InputClaim ClaimTypeReferenceId="identityProvider" TransformationClaimType="identityProvider" />
			</InputClaims>
			<OutputClaims>
				<OutputClaim ClaimTypeReferenceId="objectId" TransformationClaimType="alternativeSecurityId" />
			</OutputClaims>
      </ClaimsTransformation>
<!--
		<ClaimsTransformation Id="CreateObjectId" TransformationMethod="FormatStringMultipleClaims">
			<InputClaims>
				<InputClaim ClaimTypeReferenceId="identityProvider" TransformationClaimType="inputClaim1" />
				<InputClaim ClaimTypeReferenceId="issuerUserId" TransformationClaimType="inputClaim2" />
			</InputClaims>
			<InputParameters>
				<InputParameter Id="stringFormat" DataType="string" Value="{0}#{1}" />
			</InputParameters>
			<OutputClaims>
				<OutputClaim ClaimTypeReferenceId="objectId" TransformationClaimType="outputClaim" />
			</OutputClaims>
		</ClaimsTransformation>
-->
	</ClaimsTransformations>
	
  </BuildingBlocks>

  <ClaimsProviders>

    <ClaimsProvider>
      <DisplayName>Facebook</DisplayName>
      <TechnicalProfiles>
        <TechnicalProfile Id="Facebook-OAUTH">
          <Metadata>
            <Item Key="client_id">767588193801698</Item>
            <Item Key="scope">email public_profile</Item>
            <Item Key="ClaimsEndpoint">https://graph.facebook.com/me?fields=id,first_name,last_name,name,email</Item>
          </Metadata>
          <OutputClaimsTransformations>
            <OutputClaimsTransformation ReferenceId="CreateObjectId" />
          </OutputClaimsTransformations>
        </TechnicalProfile>
      </TechnicalProfiles>
    </ClaimsProvider>
	
	<ClaimsProvider>
	  <DisplayName>Application Insights</DisplayName>
	  <TechnicalProfiles>
		<TechnicalProfile Id="AppInsights-Common">
		  <DisplayName>Application Insights</DisplayName>
		  <Protocol Name="Proprietary" Handler="Web.TPEngine.Providers.Insights.AzureApplicationInsightsProvider, Web.TPEngine, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null" />
		  <Metadata>
			<!-- The ApplicationInsights instrumentation key which will be used for logging the events -->
			<Item Key="InstrumentationKey">89d52897-d6f1-4d52-a603-57909d668ed3</Item>
			<Item Key="DeveloperMode">true</Item>
			<Item Key="DisableTelemetry ">false</Item>
		  </Metadata>
		  <InputClaims>
			<!-- Properties of an event are added through the syntax {property:NAME}, where NAME is property being added to the event. DefaultValue can be either a static value or a value that's resolved by one of the supported DefaultClaimResolvers. -->
			<InputClaim ClaimTypeReferenceId="EventTimestamp" PartnerClaimType="{property:EventTimestamp}" DefaultValue="{Context:DateTimeInUtc}" />
			<InputClaim ClaimTypeReferenceId="PolicyId" PartnerClaimType="{property:Policy}" DefaultValue="{Policy:PolicyId}" />
			<InputClaim ClaimTypeReferenceId="CorrelationId" PartnerClaimType="{property:CorrelationId}" DefaultValue="{Context:CorrelationId}" />
		  </InputClaims>
		</TechnicalProfile>

		<TechnicalProfile Id="AppInsights-SignInRequest">
		  <InputClaims>
			<!-- An input claim with a PartnerClaimType="eventName" is required. This is used by the AzureApplicationInsightsProvider to create an event with the specified value. -->
			<InputClaim ClaimTypeReferenceId="EventType" PartnerClaimType="eventName" DefaultValue="SignInRequest" />
		  </InputClaims>
		  <IncludeTechnicalProfile ReferenceId="AppInsights-Common" />
		</TechnicalProfile>

		<TechnicalProfile Id="AppInsights-UserSignUp">
		  <InputClaims>
			<InputClaim ClaimTypeReferenceId="EventType" PartnerClaimType="eventName" DefaultValue="UserSignUp" />
		  </InputClaims>
		  <IncludeTechnicalProfile ReferenceId="AppInsights-Common" />
		</TechnicalProfile>
		
		<TechnicalProfile Id="AppInsights-SignInComplete">
		  <InputClaims>
			<InputClaim ClaimTypeReferenceId="EventType" PartnerClaimType="eventName" DefaultValue="SignInComplete" />
			<InputClaim ClaimTypeReferenceId="issuerUserId" PartnerClaimType="{property:userPrincipalName}" DefaultValue="Unknown" />
			<InputClaim ClaimTypeReferenceId="givenName" PartnerClaimType="{property:given_name}" DefaultValue="Unknown"/>
			<InputClaim ClaimTypeReferenceId="surname" PartnerClaimType="{property:family_name}" DefaultValue="Unknown"/>
			<InputClaim ClaimTypeReferenceId="email" PartnerClaimType="{property:email}" DefaultValue="Unknown"/>
			<InputClaim ClaimTypeReferenceId="sub" PartnerClaimType="{property:sub}" DefaultValue="Unknown"/>
			<InputClaim ClaimTypeReferenceId="objectGuid" PartnerClaimType="{property:objectGuid}"  DefaultValue="Unknown" />
			<InputClaim ClaimTypeReferenceId="objectId" PartnerClaimType="{property:objectId}"  DefaultValue="Unknown" />
			<InputClaim ClaimTypeReferenceId="federatedUser" PartnerClaimType="{property:FederatedUser}" DefaultValue="false" />
			<InputClaim ClaimTypeReferenceId="parsedDomain" PartnerClaimType="{property:FederationPartner}" DefaultValue="Not Applicable" />
		  </InputClaims>
		  <IncludeTechnicalProfile ReferenceId="AppInsights-Common" />
		</TechnicalProfile>
	  </TechnicalProfiles>
	</ClaimsProvider>

  </ClaimsProviders>

	<UserJourneys>

		<UserJourney Id="SignInFlowThrough">

		  <OrchestrationSteps>

			<OrchestrationStep Order="1" Type="ClaimsProviderSelection" ContentDefinitionReferenceId="api.idpselections">
			  <ClaimsProviderSelections>
				<ClaimsProviderSelection TargetClaimsExchangeId="FacebookExchange" />
			  </ClaimsProviderSelections>
			</OrchestrationStep>

			<OrchestrationStep Order="2" Type="ClaimsExchange">
			  <ClaimsExchanges>
				<ClaimsExchange Id="FacebookExchange" TechnicalProfileReferenceId="Facebook-OAUTH" />
			  </ClaimsExchanges>
			</OrchestrationStep>

			<OrchestrationStep Order="3" Type="SendClaims" CpimIssuerTechnicalProfileReferenceId="JwtIssuer" />

		  </OrchestrationSteps>

		  <ClientDefinition ReferenceId="DefaultWeb" />

		</UserJourney>
	
	</UserJourneys>


</TrustFrameworkPolicy>
